
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Birthday Garden</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåª</text></svg>">
    
    <meta property="og:title" content="Happy Birthday! üéÇ">
    <meta property="og:description" content="Come plant a flower in our digital surprise garden!">
    
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* üì∏ YOUR BACKGROUND IMAGE (Upload 'background.jpg' to GitHub) */
            --bg-image: url('gardenbackground.jpg');
        }

        body, html { margin: 0; padding: 0; overflow: hidden; height: 100%; font-family: 'Nunito', sans-serif; }

        /* --- THE WORLD --- */
        #world {
            position: relative; width: 100%; height: 100%; overflow: hidden;
            background-image: var(--bg-image);
            background-size: cover;
            background-position: center;
        }

        /* --- TITLE --- */
        #main-title { position: absolute; top: 10%; width: 100%; text-align: center; z-index: 10; pointer-events: none; }
        h1 {
            font-family: 'Dancing Script', cursive; color: #fff; font-size: 3.5rem; margin: 0;
            text-shadow: 0px 4px 10px rgba(0,0,0,0.5); animation: float 4s ease-in-out infinite;
        }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }

        /* --- UI BUTTONS --- */
        #ui { position: absolute; bottom: 30px; width: 100%; text-align: center; z-index: 50; pointer-events: none; }
        
        .big-btn { 
            pointer-events: auto; background: #FF6B6B; color: white; 
            font-family: 'Montserrat', sans-serif; font-weight: 600;
            font-size: 1.2rem;
            padding: 15px 30px; border-radius: 50px; border: none;
            box-shadow: 0 6px 0px #C92A2A, 0 10px 10px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.1s;
        }
        .big-btn:active { transform: translateY(4px); box-shadow: 0 2px 0px #C92A2A; }

        /* --- MUSIC BUTTON --- */
        #music-control {
            position: absolute; top: 20px; right: 20px; z-index: 60;
            background: white; border: none; border-radius: 50%;
            width: 50px; height: 50px; font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        #music-control:active { transform: scale(0.9); }

        /* --- DRAWING MODAL --- */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white; padding: 20px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center;
            max-width: 90%; width: 350px; position: relative;
        }
        
        /* Tools */
        .tool-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .tool-btn {
            background: #eee; border: 2px solid #ddd; padding: 8px 15px;
            border-radius: 10px; cursor: pointer; font-size: 1.2rem; font-weight: bold;
        }
        .tool-btn.active { background: #FF6B6B; color: white; border-color: #FF6B6B; }

        canvas { border: 2px dashed #ccc; border-radius: 15px; cursor: crosshair; touch-action: none; background: #fff; }

        .palette { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin: 15px 0; }
        .swatch {
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- CARD POPUP --- */
        #card-content { background: #fff9f0; border: 4px solid #FFD700; }
        #card-image { width: 180px; height: 180px; object-fit: contain; margin: 10px auto; display: block; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1)); }
        #card-wish { font-family: 'Montserrat', sans-serif; font-size: 1.1rem; color: #555; margin: 15px 0; font-style: italic; line-height: 1.5; }
        #card-sender { font-family: 'Dancing Script', cursive; font-size: 2.2rem; color: #FF6B6B; }

        /* --- FLOWER STYLING --- */
        .flower {
            position: absolute; width: 80px; height: 80px; z-index: 5;
            cursor: pointer; transform-origin: bottom center; 
            animation: sway 3s ease-in-out infinite alternate;
        }
        .flower:hover { transform: scale(1.3) translateY(-10px) !important; z-index: 99; }
        .flower img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0px 5px 5px rgba(0,0,0,0.3)); }
        @keyframes sway { from { transform: rotate(-3deg); } to { transform: rotate(3deg); } }

        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        button.secondary { background: #eee; color: #333; padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; }
        button.primary { background: #4CAF50; color: white; padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; }
      
        @media (max-width: 600px) {
    h1 { font-size: 3rem; } /* Smaller font on phones */
}  
    </style>
</head>
<body>

<audio id="bgm" loop>
    <source src="music2.mp3" type="audio/mpeg">
</audio>

<div id="world">
    <button id="music-control" onclick="toggleMusic()">üîá</button>

    <div id="garden-container"></div>
</div>

<div id="main-title">
    <h1>Chapter 26: The Wish Field</h1>
</div>

<div id="ui">
    <button class="big-btn" onclick="openDrawer()">‚úèÔ∏è Plant a Wish</button>
</div>

<div id="draw-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="tool-bar">
            <button id="btn-pen" class="tool-btn active" onclick="setTool('pen')">‚úèÔ∏è Pen</button>
            <button id="btn-bucket" class="tool-btn" onclick="setTool('bucket')">ü™£ Fill</button>
        </div>

        <canvas id="drawingCanvas" width="300" height="300"></canvas>
        <div class="palette" id="colorPalette"></div>
        <div class="btn-group">
            <button class="secondary" onclick="closeDrawer()">Cancel</button>
            <button class="secondary" onclick="clearCanvas()">Clear</button>
            <button class="primary" onclick="saveFlower()">Plant it!</button>
        </div>
    </div>
</div>

<div id="card-modal" class="modal-overlay" onclick="closeCard(event)">
    <div class="modal-box" id="card-content">
        <h2 id="card-sender">Sender Name</h2>
        <img id="card-image" src="" alt="Flower">
        <p id="card-wish">"Wish..."</p>
        <button class="secondary" onclick="document.getElementById('card-modal').style.display='none'">Close Card</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- PASTE YOUR FIREBASE CONFIG HERE ---
    const firebaseConfig = {
        apiKey: "AIzaSyCUUyrmqbyUzf5f4-GKidLsW0HsCVNjU0o",
    authDomain: "ccbirthdaygarden.firebaseapp.com",
    projectId: "ccbirthdaygarden",
    storageBucket: "ccbirthdaygarden.firebasestorage.app",
    messagingSenderId: "706882366980",
    appId: "1:706882366980:web:c7a9cc8be0b1ca0d190f51"

    };
    // ---------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Setup Canvas
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    let drawing = false;
    let currentTool = 'pen'; 
    let currentColor = '#FF6B6B'; 
    let currentRgb = { r: 255, g: 107, b: 107 }; 

    // --- MUSIC LOGIC ---
    const audio = document.getElementById('bgm');
    const musicBtn = document.getElementById('music-control');
    let musicStarted = false;

    // 1. Manual Toggle Button
    window.toggleMusic = () => {
        if (audio.paused) {
            audio.play().then(() => {
                musicBtn.innerText = "üéµ"; // Playing icon
                musicStarted = true;
            });
        } else {
            audio.pause();
            musicBtn.innerText = "üîá"; // Muted icon
        }
    };

    // 2. Auto-Start on First Click (Anywhere)
    window.addEventListener('click', () => {
        if (!musicStarted && audio.paused) {
            audio.play().then(() => {
                musicBtn.innerText = "üéµ";
                musicStarted = true;
            }).catch(() => {});
        }
    }, { once: true });


    // --- COLOR PALETTE ---
    const colors = [
        '#FF6B6B', '#FF9F43', '#FECA57', '#48DBFB', '#FF9FF3', 
        '#54a0ff', '#5f27cd', '#ff6b6b', '#1dd1a1', '#feca57',
        '#2e86de', '#8395a7', '#222f3e', '#c8d6e5', '#10ac84',
        '#01a3a4', '#f368e0', '#00d2d3', '#341f97', '#273c75'
    ];
    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
    }
    const paletteDiv = document.getElementById('colorPalette');
    colors.forEach(color => {
        const swatch = document.createElement('div');
        swatch.className = 'swatch';
        swatch.style.backgroundColor = color;
        swatch.onclick = () => {
            currentColor = color;
            currentRgb = hexToRgb(color);
            document.querySelectorAll('.swatch').forEach(s => s.style.border = '2px solid white');
            swatch.style.border = '2px solid #333';
        };
        paletteDiv.appendChild(swatch);
    });

    window.setTool = (tool) => {
        currentTool = tool;
        document.getElementById('btn-pen').className = tool === 'pen' ? 'tool-btn active' : 'tool-btn';
        document.getElementById('btn-bucket').className = tool === 'bucket' ? 'tool-btn active' : 'tool-btn';
    };

    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: Math.floor(clientX - rect.left), y: Math.floor(clientY - rect.top) };
    };

    const start = (e) => {
        const { x, y } = getPos(e);
        if (currentTool === 'bucket') {
            floodFill(x, y, currentRgb);
        } else {
            drawing = true;
            draw(e);
        }
    };
    const end = () => { drawing = false; ctx.beginPath(); };
    const draw = (e) => {
        if (!drawing || currentTool === 'bucket') return;
        const { x, y } = getPos(e);
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.strokeStyle = currentColor;
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
    };

    function floodFill(startX, startY, newColor) {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const startPos = (startY * canvas.width + startX) * 4;
        const startR = data[startPos], startG = data[startPos+1], startB = data[startPos+2], startA = data[startPos+3];

        if (startR === newColor.r && startG === newColor.g && startB === newColor.b && startA === 255) return;

        const stack = [[startX, startY]];
        while (stack.length) {
            const [x, y] = stack.pop();
            const pos = (y * canvas.width + x) * 4;
            if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
            if (data[pos] !== startR || data[pos+1] !== startG || data[pos+2] !== startB || data[pos+3] !== startA) continue;

            data[pos] = newColor.r; data[pos+1] = newColor.g; data[pos+2] = newColor.b; data[pos+3] = 255;
            stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
        }
        ctx.putImageData(imageData, 0, 0);
    }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', draw);
    window.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
    canvas.addEventListener('touchend', end);

    window.openDrawer = () => document.getElementById('draw-modal').style.display = 'flex';
    window.closeDrawer = () => document.getElementById('draw-modal').style.display = 'none';
    window.clearCanvas = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

    window.openCard = (name, wish, image) => {
        document.getElementById('card-sender').innerText = "From: " + name;
        document.getElementById('card-wish').innerText = wish;
        document.getElementById('card-image').src = image;
        document.getElementById('card-modal').style.display = 'flex';
    }
    window.closeCard = (e) => { if(e.target.id === 'card-modal') document.getElementById('card-modal').style.display = 'none'; }

    window.saveFlower = async () => {
        const name = prompt("Your Name:");
        if (!name) return;
        const wish = prompt("Write your birthday wish:");
        if (!wish) return;

        const drawingData = canvas.toDataURL("image/png");
        
        try {
            await addDoc(collection(db, "wishes"), {
                name, wish, image: drawingData,
                // PLANTING AREA: Bottom 40% (60% down the screen)
                x: Math.random() * 90 + 5, 
                y: Math.random() * 30 + 60, 
                timestamp: Date.now()
            });
            closeDrawer();
            clearCanvas();
        } catch (error) {
            alert("Error: " + error.message);
        }
    };

    const q = query(collection(db, "wishes"), orderBy("timestamp", "asc"));
    onSnapshot(q, (snapshot) => {
        const container = document.getElementById('garden-container');
        container.innerHTML = ''; 
        snapshot.forEach((doc) => {
            const data = doc.data();
            const div = document.createElement('div');
            div.className = 'flower';
            div.style.left = data.x + '%';
            div.style.top = data.y + '%';
            div.style.transform = `rotate(${(Math.random() * 20) - 10}deg)`;
            
            const img = document.createElement('img');
            img.src = data.image;
            div.appendChild(img);
            div.onclick = () => openCard(data.name, data.wish, data.image);
            container.appendChild(div);
        });
    });
</script>
</body>
</html>