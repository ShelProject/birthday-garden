<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Birthday Garden</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåª</text></svg>">
    
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* üì∏ YOUR BACKGROUND - Make sure file name matches exactly! */
            --bg-image: url('gardenbackground.jpeg'); 
        }

        body, html { margin: 0; padding: 0; overflow: hidden; height: 100%; font-family: 'Montserrat', sans-serif; }

        #world {
            position: relative; width: 100%; height: 100%; overflow: hidden;
            background-image: var(--bg-image);
            background-size: cover; background-position: center;
        }

        /* --- TITLE --- */
        #main-title { position: absolute; top: 10%; width: 100%; text-align: center; z-index: 10; cursor: default; }
        h1 {
            font-family: 'Dancing Script', cursive; color: #fff; font-size: 4.5rem; margin: 0;
            text-shadow: 0px 4px 10px rgba(0,0,0,0.5); animation: float 4s ease-in-out infinite;
            user-select: none;
        }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }

        /* --- UI --- */
        #ui { position: absolute; bottom: 30px; width: 100%; text-align: center; z-index: 50; pointer-events: none; }
        .big-btn { 
            pointer-events: auto; background: #FF6B6B; color: white; 
            font-family: 'Montserrat', sans-serif; font-weight: 600; font-size: 1.2rem;
            padding: 15px 30px; border-radius: 50px; border: none;
            box-shadow: 0 6px 0px #C92A2A, 0 10px 10px rgba(0,0,0,0.2); 
            cursor: pointer; transition: transform 0.1s;
        }
        .big-btn:active { transform: translateY(4px); box-shadow: 0 2px 0px #C92A2A; }

        #music-control {
            position: absolute; top: 20px; right: 20px; z-index: 60;
            background: white; border: none; border-radius: 50%;
            width: 50px; height: 50px; font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
        }

        /* --- MODAL --- */
        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
            z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white; padding: 20px; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: center;
            max-width: 90%; width: 350px; position: relative;
        }
        
        .tool-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .tool-btn {
            background: #eee; border: 2px solid #ddd; padding: 8px 15px;
            border-radius: 10px; cursor: pointer; font-size: 1.2rem; font-weight: bold;
        }
        .tool-btn.active { background: #FF6B6B; color: white; border-color: #FF6B6B; }

        canvas { border: 2px dashed #ccc; border-radius: 15px; cursor: crosshair; touch-action: none; background: #fff; }

        .palette { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin: 15px 0; }
        .swatch {
            width: 25px; height: 25px; border-radius: 50%; cursor: pointer;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- CARD --- */
        #card-content { background: #fff9f0; border: 4px solid #FFD700; position: relative; }
        #card-image { width: 180px; height: 180px; object-fit: contain; margin: 10px auto; display: block; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1)); }
        #card-sender { font-family: 'Dancing Script', cursive; font-size: 2.2rem; color: #FF6B6B; }
        #card-wish { font-family: 'Montserrat', sans-serif; font-size: 1.1rem; color: #555; margin: 15px 0; font-style: italic; line-height: 1.6; }
        
        #admin-delete-btn {
            display: none; background: #ff0000; color: white; width: 100%; 
            padding: 10px; border: none; font-weight: bold; margin-top: 10px; cursor: pointer;
        }

        /* --- FLOWER --- */
        .flower {
            position: absolute; width: 80px; height: 80px; z-index: 5;
            cursor: pointer; transform-origin: bottom center; 
            animation: sway 3s ease-in-out infinite alternate;
        }
        .flower:hover { transform: scale(1.3) translateY(-10px) !important; z-index: 99; }
        .flower img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0px 5px 5px rgba(0,0,0,0.3)); }
        @keyframes sway { from { transform: rotate(-3deg); } to { transform: rotate(3deg); } }

        .btn-group { display: flex; gap: 5px; justify-content: center; margin-top: 15px; flex-wrap: wrap;}
        button.secondary { background: #eee; color: #333; padding: 10px 15px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; font-family: 'Montserrat', sans-serif;}
        button.primary { background: #4CAF50; color: white; padding: 10px 20px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; font-family: 'Montserrat', sans-serif;}

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .flower { width: 60px; height: 60px; }
            h1 { font-size: 3rem; top: 15%; }
            #ui { bottom: 20px; }
        }
    </style>
</head>
<body>

<audio id="bgm" loop>
    <source src="music2.mp3" type="audio/mpeg">
</audio>

<div id="world">
    <button id="music-control" onclick="toggleMusic()">üîá</button>
    <div id="garden-container"></div>
</div>

<div id="main-title" onclick="unlockAdmin()">
    <h1>Chapter 26: In Full Bloom</h1>
</div>

<div id="ui">
    <button class="big-btn" onclick="openDrawer()">‚úèÔ∏è Plant a Wish</button>
</div>

<div id="draw-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="tool-bar">
            <button id="btn-pen" class="tool-btn active" onclick="setTool('pen')">‚úèÔ∏è Pen</button>
            <button id="btn-bucket" class="tool-btn" onclick="setTool('bucket')">ü™£ Fill</button>
        </div>
        
        <canvas id="drawingCanvas" width="300" height="300"></canvas>
        <div class="palette" id="colorPalette"></div>
        
        <div class="btn-group">
            <button class="secondary" onclick="closeDrawer()">Cancel</button>
            <button class="secondary" onclick="undoLast()">‚Ü©Ô∏è Undo</button>
            <button class="secondary" onclick="clearCanvas()">Clear</button>
            <button class="primary" onclick="saveFlower()">Plant it!</button>
        </div>
    </div>
</div>

<div id="card-modal" class="modal-overlay" onclick="closeCard(event)">
    <div class="modal-box" id="card-content">
        <h2 id="card-sender">Sender Name</h2>
        <img id="card-image" src="" alt="Flower">
        <p id="card-wish">"Wish..."</p>
        <button id="admin-delete-btn" onclick="deleteCurrentFlower()">üóëÔ∏è DELETE THIS FLOWER</button>
        <button class="secondary" onclick="document.getElementById('card-modal').style.display='none'">Close Card</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- PASTE YOUR FIREBASE CONFIG HERE ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY", 
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "123...",
        appId: "1:234..."
    };
    // ---------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Global Vars
    let currentFlowerId = null; 
    let existingFlowers = []; 
    let adminMode = false;
    let clickCount = 0;
    
    // Undo Stack
    let undoStack = []; 

    // Admin
    window.unlockAdmin = () => {
        clickCount++;
        if (clickCount === 5) {
            const pass = prompt("Enter Admin Password:");
            if (pass === "admin123") { 
                adminMode = true;
                alert("Admin Mode Unlocked!");
            } else {
                alert("Wrong password.");
            }
            clickCount = 0;
        }
    };

    window.deleteCurrentFlower = async () => {
        if (!currentFlowerId || !adminMode) return;
        if (confirm("Delete this flower?")) {
            await deleteDoc(doc(db, "wishes", currentFlowerId));
            document.getElementById('card-modal').style.display = 'none';
        }
    };

    // Canvas
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    let drawing = false;
    let currentTool = 'pen'; 
    let currentColor = '#FF3B30'; // Default Red
    let currentRgb = { r: 255, g: 59, b: 48 }; 

    // Music
    const audio = document.getElementById('bgm');
    const musicBtn = document.getElementById('music-control');
    let musicStarted = false;

    window.toggleMusic = () => {
        if (audio.paused) {
            audio.play().then(() => { musicBtn.innerText = "üéµ"; musicStarted = true; });
        } else {
            audio.pause(); musicBtn.innerText = "üîá";
        }
    };

    window.addEventListener('click', () => {
        if (!musicStarted && audio.paused) {
            audio.play().then(() => { musicBtn.innerText = "üéµ"; musicStarted = true; }).catch(() => {});
        }
    }, { once: true });

    // --- NEW COLOR PALETTE (Matches your image!) ---
    const colors = [
        '#FF3B30', '#FF2D55', '#AF52DE', '#5856D6', '#007AFF', '#34C759', 
        '#FFCC00', '#FF9500', '#FF5E3A', '#8E8E93', '#000000', '#FFFFFF',
        '#5AC8FA', '#4CD964', '#FF3B30', '#A2845E'
    ];
    
    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
    }
    const paletteDiv = document.getElementById('colorPalette');
    colors.forEach(color => {
        const swatch = document.createElement('div');
        swatch.className = 'swatch';
        swatch.style.backgroundColor = color;
        swatch.onclick = () => {
            currentColor = color;
            currentRgb = hexToRgb(color);
            document.querySelectorAll('.swatch').forEach(s => s.style.border = '2px solid white');
            swatch.style.border = '2px solid #333';
        };
        paletteDiv.appendChild(swatch);
    });

    // Undo Logic
    function saveState() {
        if (undoStack.length > 10) undoStack.shift();
        undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
    }

    window.undoLast = () => {
        if (undoStack.length > 0) {
            const lastState = undoStack.pop();
            ctx.putImageData(lastState, 0, 0);
        } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    };

    // Drawing Logic
    window.setTool = (tool) => {
        currentTool = tool;
        document.getElementById('btn-pen').className = tool === 'pen' ? 'tool-btn active' : 'tool-btn';
        document.getElementById('btn-bucket').className = tool === 'bucket' ? 'tool-btn active' : 'tool-btn';
    };

    const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: Math.floor(clientX - rect.left), y: Math.floor(clientY - rect.top) };
    };

    const start = (e) => {
        saveState(); 
        const { x, y } = getPos(e);
        if (currentTool === 'bucket') { floodFill(x, y, currentRgb); } else { drawing = true; draw(e); }
    };
    const end = () => { drawing = false; ctx.beginPath(); };
    const draw = (e) => {
        if (!drawing || currentTool === 'bucket') return;
        const { x, y } = getPos(e);
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.strokeStyle = currentColor;
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
    };

    function floodFill(startX, startY, newColor) {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        const startPos = (startY * canvas.width + startX) * 4;
        const startR = data[startPos], startG = data[startPos+1], startB = data[startPos+2], startA = data[startPos+3];
        if (startR === newColor.r && startG === newColor.g && startB === newColor.b && startA === 255) return;
        const stack = [[startX, startY]];
        while (stack.length) {
            const [x, y] = stack.pop();
            const pos = (y * canvas.width + x) * 4;
            if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
            if (data[pos] !== startR || data[pos+1] !== startG || data[pos+2] !== startB || data[pos+3] !== startA) continue;
            data[pos] = newColor.r; data[pos+1] = newColor.g; data[pos+2] = newColor.b; data[pos+3] = 255;
            stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
        }
        ctx.putImageData(imageData, 0, 0);
    }

    canvas.addEventListener('mousedown', start);
    canvas.addEventListener('mousemove', draw);
    window.addEventListener('mouseup', end);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });
    canvas.addEventListener('touchend', end);

    window.openDrawer = () => {
        undoStack = []; 
        document.getElementById('draw-modal').style.display = 'flex';
    }
    window.closeDrawer = () => document.getElementById('draw-modal').style.display = 'none';
    window.clearCanvas = () => ctx.clearRect(0, 0, canvas.width, canvas.height);

    // --- FIX: OPEN CARD WITH ID ---
    window.openCard = (id, name, wish, image) => {
        currentFlowerId = id; 
        document.getElementById('card-sender').innerText = "From: " + name;
        document.getElementById('card-wish').innerText = wish;
        document.getElementById('card-image').src = image;
        document.getElementById('card-modal').style.display = 'flex';
        
        const delBtn = document.getElementById('admin-delete-btn');
        if(delBtn) delBtn.style.display = adminMode ? 'block' : 'none';
    }
    
    window.closeCard = (e) => { if(e.target.id === 'card-modal') document.getElementById('card-modal').style.display = 'none'; }

    // --- SAVE LOGIC (SMART & MOBILE SAFE) ---
    window.saveFlower = async () => {
        const name = prompt("Your Name:");
        if (!name) return;
        const wish = prompt("Write your birthday wish:");
        if (!wish) return;

        // --- STEP 1: TAKE THE PICTURE FIRST! (Critical Fix) ---
        // We must capture the drawing BEFORE we clear the canvas.
        const drawingData = canvas.toDataURL("image/png"); 
        // ------------------------------------------------------

        // --- STEP 2: NOW close and clear ---
        closeDrawer(); 
        clearCanvas(); 

        try {
            const isMobile = window.innerWidth < 600;
            const minY = isMobile ? 55 : 60; 
            const maxY = isMobile ? 75 : 90; 
            
            let bestCandidate = { x: 0, y: 0 };
            let bestDistance = -1;
            const attempts = existingFlowers.length === 0 ? 1 : 10;

            for (let i = 0; i < attempts; i++) {
                const candidate = {
                    x: Math.random() * 80 + 10,
                    y: Math.random() * (maxY - minY) + minY
                };
                let closestDist = Number.MAX_VALUE;
                for (let f of existingFlowers) {
                    const d = Math.sqrt( Math.pow(candidate.x - f.x, 2) + Math.pow(candidate.y - f.y, 2) );
                    if (d < closestDist) closestDist = d;
                }
                if (closestDist > bestDistance) {
                    bestDistance = closestDist;
                    bestCandidate = candidate;
                }
            }

            // --- STEP 3: Save the data we captured in Step 1 ---
            await addDoc(collection(db, "wishes"), {
                name, wish, image: drawingData, // Using the saved image
                x: bestCandidate.x, 
                y: bestCandidate.y,
                timestamp: Date.now()
            });
            
        } catch (error) {
            alert("Error: " + error.message);
        }
    };

    const q = query(collection(db, "wishes"), orderBy("timestamp", "asc"));
    onSnapshot(q, (snapshot) => {
        const container = document.getElementById('garden-container');
        container.innerHTML = ''; 
        existingFlowers = []; 

        snapshot.forEach((doc) => {
            const data = doc.data();
            existingFlowers.push({ x: data.x, y: data.y }); 

            const div = document.createElement('div');
            div.className = 'flower';
            div.style.left = data.x + '%';
            div.style.top = data.y + '%';
            div.style.transform = `rotate(${(Math.random() * 20) - 10}deg)`;
            
            const img = document.createElement('img');
            img.src = data.image;
            div.appendChild(img);
            
            // --- FIX: Pass ID first, then Name ---
            div.onclick = () => openCard(doc.id, data.name, data.wish, data.image);
            
            container.appendChild(div);
        });
    });
</script>
</body>
</html>